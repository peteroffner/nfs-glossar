<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NotSan Glossar</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00796b">
<link rel="icon" href="icons/icon-192.png">
<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0; padding: 0;
  background: #f8f9fa; color: #222;
}
header {
  background: #00796b; color: white;
  text-align: center;
  padding: 1rem;
}
main { padding: 1rem; max-width: 900px; margin: auto; }
h1 { font-size: 1.6rem; margin: 0; }
.category h2 { background: #e0f2f1; padding: .5rem; border-radius: .5rem; }
details { background: white; margin: .5rem 0; padding: .5rem 1rem; border-radius: .5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
summary { font-weight: bold; cursor: pointer; }
button, select, input[type=text] {
  padding: .4rem .6rem; border-radius: .3rem; border: 1px solid #ccc; margin: .2rem;
}
.btn { background: #00796b; color: white; border: none; cursor: pointer; }
.btn.secondary { background: #455a64; }
.btn.danger { background: #c62828; }
.editor { background: #fff; padding: 1rem; border-radius: .5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
textarea { width: 100%; height: 80px; }
</style>
</head>
<body>
<header>
  <h1>ü©∫ NotSan Glossar</h1>
</header>

<main>
  <div>
    <input id="search" type="text" placeholder="üîç Suche...">
    <select id="categoryFilter"></select>
    <button id="newEntry" class="btn">+ Neuer Eintrag</button>
    <button id="exportJson" class="btn secondary">üì¶ Exportieren</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
    <button id="importJson" class="btn secondary">üì• Importieren</button>
  </div>
  <div id="content"></div>
</main>

<script>
// =========================================================
// Hilfsfunktionen
// =========================================================
const content = document.getElementById('content');
const searchEl = document.getElementById('search');
const categoryFilter = document.getElementById('categoryFilter');

function escapeHtml(text){
  return text ? text.replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m])) : "";
}

function toPlainString(x){
  if(x === null || x === undefined) return "";
  if(Array.isArray(x)) return x.join(", ");
  if(typeof x === "object") return JSON.stringify(x);
  return String(x);
}

function normalizeEntries(entries){
  return entries.map(e => ({
    name: toPlainString(e.name || e.titel || e.title || ""),
    kategorie: toPlainString(e.kategorie || e.category || "Internistisch"),
    symptome: toPlainString(e.symptome || e.symptoms || ""),
    pathophysiologie: toPlainString(e.pathophysiologie || e.patho || e.pathophysiology || ""),
    differenzialdiagnosen: toPlainString(e.differenzialdiagnosen || e.differentials || ""),
    behandlung: toPlainString(e.behandlung || e.treatment || "")
  }));
}

// =========================================================
// Daten laden (lokal oder von JSON-Datei)
// =========================================================
let data = [];
let selectedCategory = "Alle";

function loadData(){
  const local = localStorage.getItem("notsanGlossar");
  if(local){
    data = normalizeEntries(JSON.parse(local));
    renderCategories();
    renderEntries();
  } else {
    fetch("krankheitsbilder.json")
      .then(r => r.ok ? r.json() : [])
      .then(json => {
        data = normalizeEntries(json || []);
        renderCategories();
        renderEntries();
      })
      .catch(() => {
        content.innerHTML = '<p>Keine Daten gefunden. Bitte importiere eine JSON-Datei.</p>';
      });
  }
}

// =========================================================
// Darstellung
// =========================================================
function renderCategories(){
  const cats = ["Alle", ...new Set(data.map(e => e.kategorie))];
  categoryFilter.innerHTML = cats.map(c => `<option>${c}</option>`).join("");
}

function renderEntries(){
  const searchTerm = (searchEl.value || "").toLowerCase();
  const filtered = data.filter(item => {
    if(!item) return false;
    const matchesCategory = (selectedCategory === "Alle") || (item.kategorie === selectedCategory);
    const haystack = (item.name + " " + item.symptome + " " + item.pathophysiologie + " " + item.differenzialdiagnosen + " " + item.behandlung).toLowerCase();
    const matchesSearch = haystack.includes(searchTerm);
    return matchesCategory && matchesSearch;
  });

  content.innerHTML = "";
  if(filtered.length === 0){
    content.innerHTML = '<p>Keine Eintr√§ge gefunden.</p>';
    return;
  }

  const grouped = {};
  filtered.forEach(e => {
    const k = e.kategorie || "Allgemein";
    if(!grouped[k]) grouped[k] = [];
    grouped[k].push(e);
  });

  Object.keys(grouped).sort().forEach(cat => {
    const div = document.createElement("div");
    div.className = "category";
    div.innerHTML = `<h2>${escapeHtml(cat)}</h2>`;
    grouped[cat].forEach((entry, idx) => {
      const det = document.createElement("details");
      det.innerHTML = `
        <summary>${escapeHtml(entry.name)}</summary>
        <p><b>ü©∫ Symptome:</b> ${escapeHtml(entry.symptome)}</p>
        <p><b>üß¨ Pathophysiologie:</b> ${escapeHtml(entry.pathophysiologie)}</p>
        <p><b>üßæ Differenzialdiagnosen:</b> ${escapeHtml(entry.differenzialdiagnosen)}</p>
        <p><b>üíä Behandlung:</b> ${escapeHtml(entry.behandlung)}</p>
        <button class="btn secondary" onclick="openEditorFor(${data.indexOf(entry)})">Bearbeiten</button>
      `;
      div.appendChild(det);
    });
    content.appendChild(div);
  });
}

// =========================================================
// Editor
// =========================================================
function openEditorFor(index){
  const e = data[index] || {name:"",symptome:"",pathophysiologie:"",differenzialdiagnosen:"",behandlung:"",kategorie:"Internistisch"};
  content.innerHTML = `
  <div class="editor">
    <label>Name:<br><input id="editName" value="${escapeHtml(e.name)}"></label><br>
    <label>Kategorie:<br><input id="editKat" value="${escapeHtml(e.kategorie)}"></label><br>
    <label>Symptome:<br><textarea id="editSym">${escapeHtml(e.symptome)}</textarea></label><br>
    <label>Pathophysiologie:<br><textarea id="editPatho">${escapeHtml(e.pathophysiologie)}</textarea></label><br>
    <label>Differenzialdiagnosen:<br><textarea id="editDiff">${escapeHtml(e.differenzialdiagnosen)}</textarea></label><br>
    <label>Behandlung:<br><textarea id="editBeh">${escapeHtml(e.behandlung)}</textarea></label><br>
    <button class="btn" onclick="saveEdit(${index})">üíæ Speichern</button>
    <button class="btn danger" onclick="deleteEntry(${index})">üóëÔ∏è L√∂schen</button>
    <button class="btn secondary" onclick="renderEntries()">‚Ü©Ô∏è Zur√ºck</button>
  </div>`;
}

function saveEdit(index){
  const newEntry = {
    name: document.getElementById("editName").value,
    kategorie: document.getElementById("editKat").value,
    symptome: document.getElementById("editSym").value,
    pathophysiologie: document.getElementById("editPatho").value,
    differenzialdiagnosen: document.getElementById("editDiff").value,
    behandlung: document.getElementById("editBeh").value
  };
  if(index >= 0) data[index] = newEntry; else data.push(newEntry);
  localStorage.setItem("notsanGlossar", JSON.stringify(data));
  renderCategories();
  renderEntries();
}

function deleteEntry(index){
  if(confirm("Eintrag wirklich l√∂schen?")){
    data.splice(index,1);
    localStorage.setItem("notsanGlossar", JSON.stringify(data));
    renderEntries();
  }
}

// =========================================================
// Import / Export
// =========================================================
document.getElementById("exportJson").onclick = () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "krankheitsbilder.json";
  a.click();
};

document.getElementById("importJson").onclick = () => document.getElementById("importFile").click();
document.getElementById("importFile").onchange = ev => {
  const file = ev.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    data = normalizeEntries(JSON.parse(reader.result));
    localStorage.setItem("notsanGlossar", JSON.stringify(data));
    renderCategories();
    renderEntries();
  };
  reader.readAsText(file);
};

// =========================================================
// Neueintrag
// =========================================================
document.getElementById("newEntry").onclick = () => openEditorFor(-1);
searchEl.oninput = renderEntries;
categoryFilter.onchange = () => { selectedCategory = categoryFilter.value; renderEntries(); };

// =========================================================
// Start
// =========================================================
loadData();

// =========================================================
// PWA Service Worker Registrierung
// =========================================================
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
